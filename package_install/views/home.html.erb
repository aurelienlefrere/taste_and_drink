<%# ============================================ %>
<%# üè† HOME - Page d'accueil Taste & Drink %>
<%# Redesign avec carousels swipables %>
<%# ============================================ %>

<div class="td-home fade-in">
  <% if user_signed_in? %>
    <%# === UTILISATEUR CONNECT√â === %>

    <%# === LOGO DOR√â FLOTTANT === %>
    <div class="td-floating-logo">
      <%= image_tag "logo_taste_drink.png", alt: "Taste & Drink", class: "td-logo-float" %>
    </div>

    <%# Carte principale - Message de bienvenue personnalis√© %>
    <div class="td-home-hero">
      <div class="td-hero-content">
        <h2 class="td-hero-greeting">Bonjour <%= current_user.first_name || "Chef" %>,</h2>
        <p class="td-hero-description">
          Pr√™ts √† cr√©er l'accord parfait entre votre plat et votre boisson
          et en faire un moment inoubliable avec vos amis ?!
        </p>
      </div>
      <div class="td-hero-decoration">
        <i class="fas fa-wine-glass-alt"></i>
        <span>&</span>
        <i class="fas fa-utensils"></i>
      </div>
    </div>

    <%# Stats rapides (Events, Bouteilles, Amis) %>
    <div class="td-home-stats">
      <div class="td-stat-card">
        <span class="td-stat-value"><%= current_user.meals.count %></span>
        <span class="td-stat-label">Events</span>
      </div>
      <div class="td-stat-card">
        <span class="td-stat-value"><%= current_user.stocks.sum(:quantity) rescue 0 %></span>
        <span class="td-stat-label">Bouteilles</span>
      </div>
      <div class="td-stat-card">
        <span class="td-stat-value"><%= Friend.where(user_main: current_user).count %></span>
        <span class="td-stat-label">Amis</span>
      </div>
    </div>

    <%# ============================================ %>
    <%# SECTION 1: Mes Vins Not√©s (Swipable) %>
    <%# ============================================ %>
    <div class="td-home-section">
      <div class="td-section-header-row">
        <h3><i class="fas fa-star me-2"></i>Mes Vins Not√©s</h3>
        <%= link_to "Voir tout", stocks_path, class: "td-link-gold" %>
      </div>

      <%# Le data-controller connecte au Stimulus controller %>
      <div class="td-swiper" data-controller="swiper">
        <div class="td-swiper-track" data-swiper-target="track">
          <% rated_wines = current_user.stocks.includes(:drink).where.not(rating: nil).order(rating: :desc).limit(10) %>
          <% if rated_wines.any? %>
            <% rated_wines.each do |stock| %>
              <%= link_to drink_path(stock.drink), class: "td-wine-card" do %>
                <div class="td-wine-card-image">
                  <% if stock.drink.photo.present? %>
                    <%= image_tag stock.drink.photo, alt: stock.drink.title %>
                  <% else %>
                    <div class="td-wine-placeholder">
                      <i class="fas fa-wine-bottle"></i>
                    </div>
                  <% end %>
                </div>
                <div class="td-wine-card-content">
                  <span class="td-wine-name"><%= truncate(stock.drink.title, length: 18) %></span>
                  <div class="td-wine-rating">
                    <%# Affiche les √©toiles pleines %>
                    <% stock.rating.to_i.times do %>
                      <i class="fas fa-star"></i>
                    <% end %>
                    <%# Affiche les √©toiles vides %>
                    <% (5 - stock.rating.to_i).times do %>
                      <i class="far fa-star"></i>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <%# Placeholder si pas de vins not√©s %>
            <% 3.times do %>
              <div class="td-wine-card td-card-empty">
                <div class="td-wine-card-image">
                  <div class="td-wine-placeholder">
                    <i class="fas fa-wine-bottle"></i>
                  </div>
                </div>
                <div class="td-wine-card-content">
                  <span class="td-wine-name">Notez vos vins</span>
                  <span class="td-wine-type">Ajoutez des notes</span>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <%# ============================================ %>
    <%# SECTION 2: Vos Derniers Events (Swipable) %>
    <%# ============================================ %>
    <div class="td-home-section">
      <div class="td-section-header-row">
        <h3><i class="fas fa-calendar-alt me-2"></i>Vos Derniers Events</h3>
        <%= link_to "Voir tout", meals_path, class: "td-link-gold" %>
      </div>

      <div class="td-swiper" data-controller="swiper">
        <div class="td-swiper-track" data-swiper-target="track">
          <% recent_events = current_user.meals.order(created_at: :desc).limit(10) %>
          <% if recent_events.any? %>
            <% recent_events.each do |event| %>
              <%= link_to meal_path(event), class: "td-event-mini-card" do %>
                <%# Date de l'event %>
                <div class="td-event-date-badge">
                  <span class="td-event-day"><%= event.date&.strftime("%d") || event.created_at.strftime("%d") %></span>
                  <span class="td-event-month"><%= event.date&.strftime("%b") || event.created_at.strftime("%b") %></span>
                </div>

                <%# Nom du plat %>
                <div class="td-event-dish-name">
                  <%= truncate(event.dish_name, length: 30) %>
                </div>

                <%# Boisson associ√©e %>
                <% if event.meal_drinks.first %>
                  <div class="td-event-drink-info">
                    <%= truncate(event.meal_drinks.first.drink.title, length: 25) %>
                  </div>
                <% end %>

                <%# Avatars des amis %>
                <% if event.guests.any? %>
                  <div class="td-event-guests-mini">
                    <% event.guests.first(3).each do |guest| %>
                      <div class="td-guest-avatar-mini">
                        <% if guest.user.photo.present? %>
                          <%= image_tag guest.user.photo, alt: guest.user.first_name %>
                        <% else %>
                          <span><%= guest.user.first_name&.first&.upcase || "?" %></span>
                        <% end %>
                      </div>
                    <% end %>
                    <% if event.guests.count > 3 %>
                      <div class="td-guest-avatar-mini td-avatar-more">
                        <span>+<%= event.guests.count - 3 %></span>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              <% end %>
            <% end %>
          <% else %>
            <%# Message si pas d'events %>
            <div class="td-event-mini-card td-card-empty">
              <div class="td-empty-icon-mini">
                <i class="fas fa-calendar-plus"></i>
              </div>
              <span>Cr√©ez votre premier event</span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

  <% else %>
    <%# === UTILISATEUR NON CONNECT√â === %>
    <div class="td-welcome">
      <div class="td-welcome-logo">
        <%= image_tag "logo_taste_drink.png", alt: "Taste & Drink" %>
      </div>

      <h1 class="td-welcome-title">Taste & Drink</h1>
      <p class="td-welcome-tagline">L'accord parfait entre votre plat et votre boisson</p>

      <div class="td-welcome-features">
        <div class="td-feature">
          <i class="fas fa-camera"></i>
          <span>Scannez vos bouteilles</span>
        </div>
        <div class="td-feature">
          <i class="fas fa-brain"></i>
          <span>IA Sommelier</span>
        </div>
        <div class="td-feature">
          <i class="fas fa-users"></i>
          <span>Partagez avec vos amis</span>
        </div>
      </div>

      <div class="td-welcome-actions">
        <%= link_to "Cr√©er un compte", new_user_registration_path, class: "btn btn-pink-glossy btn-lg" %>
        <%= link_to "Se connecter", new_user_session_path, class: "btn btn-gold-outline btn-lg" %>
      </div>
    </div>
  <% end %>
</div>
