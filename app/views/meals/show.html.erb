<div class="td-home-section">

  <%# V√©rifier si c'est un √©v√©nement valid√© (historique) %>
  <% validated_drinks = @meal.meal_drinks.where(status: "validated") %>
  <% is_event = validated_drinks.any? %>

  <% if is_event %>
    <%# ========================================
        MODE HISTORIQUE : Affichage de l'√©v√©nement valid√©
        ======================================== %>

    <div class="meal-event-header">
      <h2>
        <i class="fas fa-utensils"></i> <%= @meal.dish_name %>
      </h2>
      <p class="meal-event-date">
        <%= l(@meal.date || @meal.created_at, format: :long) %>
      </p>
      <p class="meal-event-count">
        <%= validated_drinks.count %> boisson<%= validated_drinks.count > 1 ? 's' : '' %> s√©lectionn√©e<%= validated_drinks.count > 1 ? 's' : '' %>
      </p>
    </div>

    <%# Affichage des boissons valid√©es uniquement %>
    <div class="cards">
      <% validated_drinks.each do |meal_drink| %>
        <div class="td-wine-card w-100">
          <div class="td-wine-card-image">
            <div class="td-wine-placeholder">
              <% if meal_drink.drink.photo.present? %>
                <%= image_tag(meal_drink.drink.photo, class: "stock-image-container", alt: "#{meal_drink.drink.title}") %>
              <% else %>
                <div class="wine-placeholder-empty">üç∑</div>
              <% end %>
            </div>
          </div>
          <div class="td-wine-card-content">
            <span class="stock-title"><%= meal_drink.drink.title %></span>
            <p class="wine-category">
              <%= meal_drink.drink.category %>
              <% if meal_drink.drink.year.present? %>
                ‚Ä¢ <%= meal_drink.drink.year %>
              <% end %>
            </p>
            <% if meal_drink.drink.region.present? %>
              <p class="wine-region">
                <%= meal_drink.drink.region %>
              </p>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <%# Bouton retour √† l'historique %>
    <div class="td-match-submit">
      <%= link_to meals_path, class: "btn btn-gold td-btn-match" do %>
        <i class="fas fa-arrow-left"></i> Retour √† l'historique
      <% end %>
    </div>

  <% else %>
    <%# ========================================
        MODE S√âLECTION : Page de recommandations avec s√©lection
        ======================================== %>

    <%= form_with url: create_event_meal_path(@meal),
                  method: :post,
                  id: "event-form",
                  data: {
                    controller: "meal-show",
                    meal_show_target: "form"
                  } do |f| %>

      <div class="meal-selection-header">
        <div>
          <h3><i class="fas fa-brain"></i> Recommandations pour <%= @meal.dish_name %></h3>
          <p class="meal-selection-subtitle">
            Cliquez sur les boissons pour les s√©lectionner
          </p>
        </div>
      </div>

      <%# --- üè† Dans ma cave --- %>
      <%# <% my_cellar = @meal.meal_drinks.joins(drink: :stocks).where(status: "recommendation", stocks: { user_id: current_user.id }) %>
      <% if @my_cellar.any? %>
        <h4>Dans ma cave</h4>
        <div class="cards">
          <% @my_cellar.each do |drink| %>
            <label class="td-wine-card w-100 drink-selectable"
                   data-meal-show-target="drinkCard"
                   data-action="click->meal-show#toggleSelection">

              <%= check_box_tag "selected_meal_drink_ids[]", drink.id, false,
                  class: "drink-checkbox",
                  data: { meal_show_target: "checkbox" } %>

              <div class="td-wine-card-image">
                <div class="td-wine-placeholder">
                  <%= image_tag(drink.photo, class: "stock-image-container", alt: "#{drink.title}") %>
                </div>
              </div>
              <div class="td-wine-card-content">
                <span class="stock-title"><%= drink.title %></span>
              </div>
            </label>
          <% end %>
        </div>
      <% end %>

      <%# --- üç∑ Vins --- %>
      <%# <% wines = @meal.meal_drinks.joins(:drink).where(status: "recommendation", drinks: { category: "Vin" }) %>
      <% if @drinks_wine.any? %>
        <h4>Vins</h4>
        <div class="cards">
          <% @drinks_wine.each do |drink| %>
            <label class="td-wine-card w-100 drink-selectable"
                   data-meal-show-target="drinkCard"
                   data-action="click->meal-show#toggleSelection">

              <%= check_box_tag "selected_meal_drink_ids[]", drink.id, false,
                  class: "drink-checkbox",
                  data: { meal_show_target: "checkbox" } %>

              <div class="td-wine-card-image">
                <div class="td-wine-placeholder">
                  <%= image_tag(drink.photo, class: "stock-image-container", alt: "#{drink.title}") %>
                </div>
              </div>
              <div class="td-wine-card-content">
                <span class="stock-title"><%= drink.title %></span>
              </div>
            </label>
          <% end %>
        </div>
      <% end %>

      <%# --- üç∏ Boissons alcoolis√©es --- %>
      <%# <% alcohol = @meal.meal_drinks.joins(:drink).where(status: "recommendation", drinks: { category: "Alcoolis√©e" }) %>
      <% if @drinks_alcohol.any? %>
        <h4>Boissons alcoolis√©es</h4>
        <div class="cards">
          <% @drinks_alcohol.each do |drink| %>
            <label class="td-wine-card w-100 drink-selectable"
                   data-meal-show-target="drinkCard"
                   data-action="click->meal-show#toggleSelection">

              <%= check_box_tag "selected_meal_drink_ids[]", drink.id, false,
                  class: "drink-checkbox",
                  data: { meal_show_target: "checkbox" } %>

              <div class="td-wine-card-image">
                <div class="td-wine-placeholder">
                  <%= image_tag(drink.photo, class: "stock-image-container", alt: "#{drink.title}") %>
                </div>
              </div>
              <div class="td-wine-card-content">
                <span class="stock-title"><%= drink.title %></span>
              </div>
            </label>
          <% end %>
        </div>
      <% end %>

      <%# --- ü•§ Boissons sans alcool --- %>
      <%# <% no_alcohol = @meal.meal_drinks.joins(:drink).where(status: "recommendation", drinks: { category: "Non alcoolis√©e" }) %>
      <% if @drinks_no_alcohol.any? %>
        <h4>Boissons sans alcool</h4>
        <div class="cards">
          <% @drinks_no_alcohol.each do |drink| %>
            <label class="td-wine-card w-100 drink-selectable"
                   data-meal-show-target="drinkCard"
                   data-action="click->meal-show#toggleSelection">

              <%= check_box_tag "selected_meal_drink_ids[]", drink.id, false,
                  class: "drink-checkbox",
                  data: { meal_show_target: "checkbox" } %>

              <div class="td-wine-card-image">
                <div class="td-wine-placeholder">
                  <%= image_tag(drink.photo, class: "stock-image-container", alt: "#{drink.title}") %>
                </div>
              </div>
              <div class="td-wine-card-content">
                <span class="stock-title"><%= drink.title %></span>
              </div>
            </label>
          <% end %>
        </div>
      <% end %>

      <%# --- üé≤ Suggestions improbables --- %>
      <%# <% improbable = @meal.meal_drinks.joins(:drink).where(status: "recommendation", drinks: { category: "Improbable" }) %>
      <% if @drinks_impro.any? %>
        <h4>Suggestions improbables</h4>
        <div class="cards">
          <% @drinks_impro.each do |drink| %>
            <label class="td-wine-card w-100 drink-selectable"
                   data-meal-show-target="drinkCard"
                   data-action="click->meal-show#toggleSelection">

              <%= check_box_tag "selected_meal_drink_ids[]", drink.id, false,
                  class: "drink-checkbox",
                  data: { meal_show_target: "checkbox" } %>

              <div class="td-wine-card-image">
                <div class="td-wine-placeholder">
                  <%= image_tag(drink.photo, class: "stock-image-container", alt: "#{drink.title}") %>
                </div>
              </div>
              <div class="td-wine-card-content">
                <span class="stock-title"><%= drink.title %></span>
              </div>
            </label>
          <% end %>
        </div>
      <% end %>

      <%# Bouton submit cach√© %>
      <%= f.submit "Valider l'√©v√©nement", style: "display: none;" %>

    <% end %>

  <% end %>

</div>
