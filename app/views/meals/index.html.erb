<%# ============================================ %>
<%# üìÖ EVENTS - Liste des accords plat/boisson %>
<%# ============================================ %>
<%#
  Cette page affiche tous les "events" (repas) cr√©√©s par l'utilisateur
  via l'onglet "Match". Chaque card montre :
  - La date de l'event
  - Le nom du plat
  - Les boissons avec leur note (cliquable pour noter)
  - Les avatars des amis invit√©s
%>

<div class="td-events-page fade-in">

  <%# === HEADER === %>
  <div class="td-events-header">
    <div>
      <h1 class="td-page-title">Mes Events</h1>
      <p class="td-page-subtitle"><%= @meals.count %> accord<%= @meals.count > 1 ? 's' : '' %> cr√©√©<%= @meals.count > 1 ? 's' : '' %></p>
    </div>
    <%# Bouton rond pour cr√©er un nouveau match %>
    <%= link_to new_meal_path, class: "td-btn-new-event" do %>
      <i class="fas fa-plus"></i>
    <% end %>
  </div>

  <%# === LISTE DES EVENTS === %>
  <% if @meals.any? %>
    <div class="td-events-list">
      <% @meals.each do |meal| %>

        <%# === CARD D'UN EVENT === %>
        <%# Le data-controller connecte cette card au controller Stimulus "rating" %>
        <div class="td-event-card" data-controller="rating" data-rating-meal-id-value="<%= meal.id %>">

          <%# --- En-t√™te : Date et Plat --- %>
          <div class="td-event-header">
            <%# Badge de date %>
            <div class="td-event-date">
              <span class="td-date-day"><%= meal.date&.strftime("%d") || meal.created_at.strftime("%d") %></span>
              <span class="td-date-month"><%= meal.date&.strftime("%b") || meal.created_at.strftime("%b") %></span>
            </div>
            <%# Infos du plat %>
            <div class="td-event-info">
              <h3 class="td-event-dish"><%= meal.dish_name %></h3>
              <p class="td-event-meta">
                <i class="fas fa-wine-glass-alt"></i> <%= meal.meal_drinks.count %> boisson<%= meal.meal_drinks.count > 1 ? 's' : '' %>
                <% if meal.guests.any? %>
                  <span class="td-meta-separator">‚Ä¢</span>
                  <i class="fas fa-users"></i> <%= meal.guests.count %> invit√©<%= meal.guests.count > 1 ? 's' : '' %>
                <% end %>
              </p>
            </div>
          </div>

          <%# --- Section Boissons avec notation par √©toiles --- %>
          <% if meal.meal_drinks.any? %>
            <div class="td-event-drinks">
              <% meal.meal_drinks.each do |meal_drink| %>
                <div class="td-drink-item">
                  <%# Image de la bouteille %>
                  <div class="td-drink-image">
                    <% if meal_drink.drink.photo.present? %>
                      <img src="<%= meal_drink.drink.photo %>" alt="<%= meal_drink.drink.title %>">
                    <% else %>
                      <div class="td-drink-placeholder">
                        <i class="fas fa-wine-bottle"></i>
                      </div>
                    <% end %>
                  </div>

                  <%# Infos de la boisson %>
                  <div class="td-drink-info">
                    <span class="td-drink-name"><%= truncate(meal_drink.drink.title, length: 25) %></span>
                    <span class="td-drink-details">
                      <%= meal_drink.drink.category %>
                      <% if meal_drink.drink.year.present? %>
                        ‚Ä¢ <%= meal_drink.drink.year %>
                      <% end %>
                    </span>

                    <%# === SYST√àME DE NOTATION PAR √âTOILES === %>
                    <div class="td-rating" data-meal-drink-id="<%= meal_drink.id %>">
                      <% (1..5).each do |star| %>
                        <button type="button"
                                class="td-star <%= 'active' if meal_drink.rating && star <= meal_drink.rating %>"
                                data-action="click->rating#rate"
                                data-star-value="<%= star %>"
                                data-meal-drink-id="<%= meal_drink.id %>">
                          <i class="<%= meal_drink.rating && star <= meal_drink.rating ? 'fas' : 'far' %> fa-star"></i>
                        </button>
                      <% end %>
                      <span class="td-rating-label">
                        <% if meal_drink.rating %>
                          <%= meal_drink.rating %>/5
                        <% else %>
                          Noter
                        <% end %>
                      </span>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>

          <%# --- Section Invit√©s (petits avatars ronds) --- %>
          <% if meal.guests.any? %>
            <div class="td-event-guests">
              <span class="td-guests-label">Avec</span>
              <div class="td-guests-avatars">
                <% meal.guests.first(5).each do |guest| %>
                  <div class="td-guest-avatar" title="<%= guest.user.first_name %>">
                    <% if guest.user.photo.present? %>
                      <%= image_tag guest.user.photo, alt: guest.user.first_name %>
                    <% else %>
                      <span class="td-avatar-initial"><%= guest.user.first_name&.first&.upcase || "?" %></span>
                    <% end %>
                  </div>
                <% end %>
                <% if meal.guests.count > 5 %>
                  <div class="td-guest-avatar td-avatar-more">
                    <span>+<%= meal.guests.count - 5 %></span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

        </div>

      <% end %>
    </div>
  <% else %>
    <%# === √âTAT VIDE === %>
    <div class="td-empty-state">
      <div class="td-empty-icon">
        <i class="fas fa-calendar-plus"></i>
      </div>
      <h3>Aucun event</h3>
      <p>Cr√©ez votre premier accord plat & boisson !</p>
      <%= link_to "Cr√©er un Match", new_meal_path, class: "btn btn-gold" %>
    </div>
  <% end %>

</div>
